# 瀑布流无限滚动功能开发与调试随想录

本文档记录了为实现首页瀑布流无限滚动功能，从初步实现到解决一个顽固的“洗牌”Bug 的全过程。

## 初始目标与实现

项目的初始目标是实现一个瀑布流布局的卡片列表，当用户滚动到页面底部时，能自动加载下一批卡片，并伴有优雅的动画效果。

初步的技术方案是：
1.  使用 `useIntersectionObserver` (来自 `@vueuse/core`) 来监听一个位于列表底部的“哨兵”元素，以触发加载。
2.  通过 `loadMore` 函数，动态地向 `DisplayCards` 数组中追加新数据。

## “洗牌”Bug 的艰难调试历程

在实现了基本的无限滚动后，我们遇到了一个非常顽固且奇怪的 Bug：**只有在加载第二组卡片时，第一组已经渲染好的卡片布局会被完全打乱。而后续加载第三、四组时，则表现正常。**

为了解决这个问题，我们进行了漫长而曲折的探索：

### 尝试 1：添加 Vue 的 `:key` (失败)
- **猜测**：Vue 的虚拟 DOM 在更新列表时，因缺少唯一的 `key` 而无法正确追踪元素，导致了错误的 DOM 复用和排序。
- **操作**：在渲染的卡片组件上添加了 `:key="item.id"`。
- **结果**：问题依旧。

### 尝试 2：使用库的 `:key-mapper` (失败)
- **猜测**：可能是第一个库 `@yeger/vue-masonry-wall` 需要通过专门的 prop 来接收 key，以便其内部计算逻辑使用。
- **操作**：按照文档，使用了 `:key-mapper="(item) => item.id"`。
- **结果**：问题依旧。

### 尝试 3：修改加载时机 (失败)
- **猜测**：可能是库的“初始化”逻辑与“更新”逻辑有差异，导致从初始状态到第一次更新时出现 Bug。
- **操作**：修改了 `onMounted` 钩子，让页面以空数组状态渲染，然后立刻调用 `loadMore` 来加载第一批数据，试图绕过“初始化”逻辑。
- **结果**：问题依旧。

### 尝试 4：移除“异类”菜单项 (失败)
- **猜测**：由用户提出，非常合理。列表中唯一的“异类”——菜单卡片（不同的 id 类型、不同的渲染组件）可能是干扰库计算的元凶。
- **操作**：暂时将菜单卡片从数据源和模板中移除。
- **结果**：问题依旧。这个结果意义重大，它基本排除了是我们自身数据的问题。

### 尝试 5：更换瀑布流库 (失败)
- **猜测**：第一个库 `@yeger/vue-masonry-wall` 本身存在无法绕过的 Bug。
- **操作**：卸载旧库，换用了社区更主流、基于 Masonry.js 的 `vue-masonry-css`。
- **结果**：**问题竟然一模一样地复现了！** 这成为了最终的破案关键，证明了问题根源与我们使用的具体库无关。

## 最终诊断与解决方案

**核心原因**：**布局计算与图片加载的“赛跑”问题 (Race Condition)**。

- **精确时间线**：
    1.  **初次渲染**：瀑布流库基于**不包含图片高度**（因为图片还在网络上下载）的“卡片骨架”进行布局计算。此时卡片很矮。
    2.  **图片加载完成**：在下次加载前，第一批卡片的图片下载完毕，撑开了卡片的真实高度。
    3.  **二次加载**：当加载第二批数据时，库回头一看，发现第一批卡片的高度和它最初计算的完全不同，它必须抛弃旧的计算结果，根据“9个高个子 + 9个新来的矮个子”重新进行全局计算，导致了布局的剧烈“洗牌”。
    4.  **后续加载**：因为大部分“地基”卡片的高度已经稳定，所以后续的重新计算对顶部布局影响很小，问题看起来“消失”了。

**最终解决方案**：**CSS 固定宽高比 (Aspect Ratio)**。

不依赖任何 JS，在图片加载出来之前，就用一个有正确宽高比的容器为它“占坑”。这样，瀑布流库从第一次计算开始，获取到的就是最终的、正确的高度。

**修复代码 (`HomeCard.vue`)**:
```html
<!-- 封面 -->
<div class="overflow-hidden aspect-[4/3] bg-gray-200 dark:bg-gray-700">
  <img
    :src="home.coverUrl"
    alt="Room cover"
    class="w-full h-full object-cover transition-all duration-300 ease-in-out group-hover/card:scale-105"
  />
</div>
```

## 当前状态与下一步

- **当前使用库**：我们已经回滚到了第一个库 `@yeger/vue-masonry-wall`。
- **唯一待办**：**应用“固定宽高比”修复**。用户需要批准对 `HomeCard.vue` 的修改。
- **最终目标**：在 Bug 修复后，完成 `todo-list.md` 中的第三阶段，即安装 `@formkit/auto-animate` 并为卡片出现添加动画。
